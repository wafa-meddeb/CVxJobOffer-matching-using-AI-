{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="analytics-container">
    <!-- Header Section -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1 class="dashboard-title">
                <i class="fas fa-chart-bar"></i>
                Analytics Dashboard
            </h1>
            <p class="dashboard-subtitle">
                Comprehensive insights into your resume matching system performance
            </p>
        </div>
        <div class="dashboard-actions">
            <button id="refresh-all-btn" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i>
                Refresh All
            </button>
            <button id="export-btn" class="btn btn-secondary">
                <i class="fas fa-download"></i>
                Export Data
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading analytics data...</p>
        </div>
    </div>

    <!-- Error Alert -->
    <div id="error-alert" class="error-alert" style="display: none;">
        <div class="error-content">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="error-message">An error occurred while loading data</span>
            <button id="retry-btn" class="btn btn-small">Retry</button>
        </div>
    </div>

    <!-- Main Statistics Cards -->
    <div class="stats-grid">
        <div class="metric-card" data-metric="jobs">
            <div class="metric-icon">
                <i class="fas fa-briefcase"></i>
            </div>
            <div class="metric-content">
                <p class="metric-label">Total Jobs</p>
                <h3 class="metric-value" id="total-jobs">0</h3>
                <span class="metric-change" id="jobs-change">
                    <i class="fas fa-arrow-up"></i>
                    +0% from last week
                </span>
            </div>
        </div>
        
        <div class="metric-card" data-metric="resumes">
            <div class="metric-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="metric-content">
                <p class="metric-label">Total Resumes</p>
                <h3 class="metric-value" id="total-resumes">0</h3>
                <span class="metric-change" id="resumes-change">
                    <i class="fas fa-arrow-up"></i>
                    +0% from last week
                </span>
            </div>
        </div>
        
        <div class="metric-card" data-metric="matches">
            <div class="metric-icon">
                <i class="fas fa-bullseye"></i>
            </div>
            <div class="metric-content">
                <p class="metric-label">Total Matches</p>
                <h3 class="metric-value" id="total-matches">0</h3>
                <span class="metric-change" id="matches-change">
                    <i class="fas fa-arrow-up"></i>
                    +0% from last week
                </span>
            </div>
        </div>
        
        <div class="metric-card" data-metric="score">
            <div class="metric-icon">
                <i class="fas fa-star"></i>
            </div>
            <div class="metric-content">
                <p class="metric-label">Avg. Score</p>
                <h3 class="metric-value" id="avg-score">0%</h3>
                <span class="metric-change" id="score-change">
                    Best: <span id="max-score">0</span>%
                </span>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <!-- Match Score Distribution -->
        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title-group">
                    <h3>
                        <i class="fas fa-chart-pie"></i>
                        Match Score Distribution
                    </h3>
                    <p class="chart-subtitle">Distribution of matching scores across all candidates</p>
                </div>
                <div class="chart-controls">
                    <button class="btn-filter active" data-period="all">All Time</button>
                    <button class="btn-filter" data-period="30">30 Days</button>
                    <button class="btn-filter" data-period="7">7 Days</button>
                </div>
            </div>
            <div class="chart-content">
                <div class="score-distribution" id="score-distribution">
                    <div class="score-bar" data-range="90-100">
                        <div class="score-label">
                            <span class="score-range">
                                <i class="fas fa-trophy"></i>
                                90-100% (Excellent)
                            </span>
                            <span class="score-count" id="score-90-100">0</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill excellent" style="width: 0%" id="bar-90-100"></div>
                        </div>
                    </div>
                    <div class="score-bar" data-range="80-89">
                        <div class="score-label">
                            <span class="score-range">
                                <i class="fas fa-medal"></i>
                                80-89% (Very Good)
                            </span>
                            <span class="score-count" id="score-80-89">0</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill good" style="width: 0%" id="bar-80-89"></div>
                        </div>
                    </div>
                    <div class="score-bar" data-range="70-79">
                        <div class="score-label">
                            <span class="score-range">
                                <i class="fas fa-thumbs-up"></i>
                                70-79% (Good)
                            </span>
                            <span class="score-count" id="score-70-79">0</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill average" style="width: 0%" id="bar-70-79"></div>
                        </div>
                    </div>
                    <div class="score-bar" data-range="60-69">
                        <div class="score-label">
                            <span class="score-range">
                                <i class="fas fa-meh"></i>
                                60-69% (Fair)
                            </span>
                            <span class="score-count" id="score-60-69">0</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill below-average" style="width: 0%" id="bar-60-69"></div>
                        </div>
                    </div>
                    <div class="score-bar" data-range="below-60">
                        <div class="score-label">
                            <span class="score-range">
                                <i class="fas fa-frown"></i>
                                &lt;60% (Needs Improvement)
                            </span>
                            <span class="score-count" id="score-below-60">0</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill poor" style="width: 0%" id="bar-below-60"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Timeline -->
        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title-group">
                    <h3>
                        <i class="fas fa-chart-line"></i>
                        Matching Activity Timeline
                    </h3>
                    <p class="chart-subtitle">Daily matching activity and average scores over time</p>
                </div>
                <div class="refresh-indicator">
                    <span>Last updated: <span id="last-updated">Never</span></span>
                    <button class="btn-refresh" id="refresh-chart-btn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="chart-content">
                <div class="chart-container">
                    <canvas id="activity-chart"></canvas>
                </div>
                <div class="chart-legend" id="chart-legend">
                    <div class="legend-item">
                        <span class="legend-color" style="background: #4299e1;"></span>
                        <span>Daily Matches</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #10b981;"></span>
                        <span>Average Score</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Section -->
    <div class="details-section">
        <!-- Top Matches -->
        <div class="detail-card">
            <div class="detail-header">
                <div class="header-info">
                    <h3>
                        <i class="fas fa-trophy"></i>
                        Top Matches
                    </h3>
                    <span class="detail-subtitle">Highest scoring candidate-job matches</span>
                </div>
                <button class="btn btn-small" id="view-all-matches">View All</button>
            </div>
            <div class="detail-content">
                <div class="top-matches-list" id="top-matches-list">
                    <div class="loading-state">
                        <div class="loading-skeleton"></div>
                        <div class="loading-skeleton"></div>
                        <div class="loading-skeleton"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="detail-card">
            <div class="detail-header">
                <div class="header-info">
                    <h3>
                        <i class="fas fa-clock"></i>
                        Recent Activity
                    </h3>
                    <span class="detail-subtitle">Latest matching operations</span>
                </div>
                <button class="btn btn-small" id="view-all-activity">View All</button>
            </div>
            <div class="detail-content">
                <div class="recent-activity-list" id="recent-activity-list">
                    <div class="loading-state">
                        <div class="loading-skeleton"></div>
                        <div class="loading-skeleton"></div>
                        <div class="loading-skeleton"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Insights Section -->
    <div class="insights-section">
        <div class="insight-card">
            <div class="insight-header">
                <h3>
                    <i class="fas fa-building"></i>
                    Top Companies
                </h3>
                <span class="insight-subtitle">Most active employers</span>
            </div>
            <div class="insight-content">
                <div id="top-companies" class="insight-list">
                    <div class="loading-state">
                        <div class="loading-skeleton small"></div>
                        <div class="loading-skeleton small"></div>
                        <div class="loading-skeleton small"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="insight-card">
            <div class="insight-header">
                <h3>
                    <i class="fas fa-tools"></i>
                    Most Demanded Skills
                </h3>
                <span class="insight-subtitle">Top skills in job requirements</span>
            </div>
            <div class="insight-content">
                <div id="top-skills" class="insight-list">
                    <div class="loading-state">
                        <div class="loading-skeleton small"></div>
                        <div class="loading-skeleton small"></div>
                        <div class="loading-skeleton small"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="insight-card">
            <div class="insight-header">
                <h3>
                    <i class="fas fa-graduation-cap"></i>
                    Experience Levels
                </h3>
                <span class="insight-subtitle">Distribution by experience</span>
            </div>
            <div class="insight-content">
                <div id="experience-levels" class="insight-list">
                    <div class="loading-state">
                        <div class="loading-skeleton small"></div>
                        <div class="loading-skeleton small"></div>
                        <div class="loading-skeleton small"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Base Styles */
.analytics-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f8fafc;
    min-height: 100vh;
}

/* Dashboard Header */
.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.header-content h1.dashboard-title {
    font-size: 2.5rem;
    font-weight: 800;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.dashboard-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    margin: 0.5rem 0 0 0;
}

.dashboard-actions {
    display: flex;
    gap: 1rem;
}

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.loading-overlay.hidden {
    display: none;
}

.loading-spinner {
    text-align: center;
    color: #4a5568;
}

.spinner {
    border: 4px solid #f3f4f6;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Error Alert */
.error-alert {
    background: #fed7d7;
    border: 1px solid #fc8181;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.error-content {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
}

.error-content i {
    color: #e53e3e;
    font-size: 1.2rem;
}

/* Buttons */
.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    font-size: 0.9rem;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn-primary {
    background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
    color: white;
}

.btn-secondary {
    background: #edf2f7;
    color: #4a5568;
}

.btn-small {
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
}

.btn-refresh {
    background: none;
    border: none;
    color: #718096;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.btn-refresh:hover {
    background: #e2e8f0;
    color: #4a5568;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.metric-card {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.metric-card:nth-child(1)::before { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.metric-card:nth-child(2)::before { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.metric-card:nth-child(3)::before { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.metric-card:nth-child(4)::before { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

.metric-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
}

.metric-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.metric-card:nth-child(1) .metric-icon { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.metric-card:nth-child(2) .metric-icon { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.metric-card:nth-child(3) .metric-icon { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.metric-card:nth-child(4) .metric-icon { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

.metric-content {
    flex: 1;
}

.metric-label {
    margin: 0 0 0.5rem 0;
    font-size: 0.9rem;
    color: #718096;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.metric-value {
    margin: 0 0 0.5rem 0;
    font-size: 2.5rem;
    font-weight: 800;
    color: #2d3748;
    line-height: 1;
}

.metric-change {
    font-size: 0.85rem;
    color: #48bb78;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

/* Charts Section */
.charts-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

@media (max-width: 1024px) {
    .charts-section {
        grid-template-columns: 1fr;
    }
}

.chart-card {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    gap: 1rem;
}

.chart-title-group h3 {
    margin: 0 0 0.5rem 0;
    color: #2d3748;
    font-size: 1.4rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.chart-subtitle {
    margin: 0;
    color: #718096;
    font-size: 0.9rem;
}

.chart-controls {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

.btn-filter {
    padding: 0.5rem 1rem;
    border: 1px solid #e2e8f0;
    background: white;
    border-radius: 8px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
}

.btn-filter:hover,
.btn-filter.active {
    background: #4299e1;
    color: white;
    border-color: #4299e1;
}

.chart-content {
    position: relative;
}

/* Score Distribution */
.score-distribution {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.score-bar {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.score-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.score-range {
    font-size: 0.9rem;
    color: #4a5568;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.score-count {
    background: #f7fafc;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
    color: #2d3748;
}

.progress-bar {
    height: 16px;
    background: #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
}

.progress-fill {
    height: 100%;
    transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 8px;
    position: relative;
}

.progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.progress-fill.excellent { background: linear-gradient(90deg, #48bb78, #68d391); }
.progress-fill.good { background: linear-gradient(90deg, #4299e1, #63b3ed); }
.progress-fill.average { background: linear-gradient(90deg, #ed8936, #f6ad55); }
.progress-fill.below-average { background: linear-gradient(90deg, #f56565, #fc8181); }
.progress-fill.poor { background: linear-gradient(90deg, #e53e3e, #feb2b2); }

/* Chart Container */
.chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 1rem;
}

#activity-chart {
    width: 100% !important;
    height: 100% !important;
}

.chart-legend {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-top: 1rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: #4a5568;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.refresh-indicator {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.8rem;
    color: #718096;
}

/* Details Section */
.details-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

@media (max-width: 768px) {
    .details-section {
        grid-template-columns: 1fr;
    }
}

.detail-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
    overflow: hidden;
}

.detail-header {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-info h3 {
    margin: 0 0 0.25rem 0;
    color: #2d3748;
    font-size: 1.2rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.detail-subtitle {
    color: #718096;
    font-size: 0.9rem;
    margin: 0;
}

.detail-content {
    padding: 1.5rem 2rem;
}

/* Match Items */
.top-matches-list,
.recent-activity-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.match-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 12px;
    border-left: 4px solid #4299e1;
    transition: all 0.2s ease;
}

.match-item:hover {
    background: #edf2f7;
    transform: translateX(4px);
}

.match-info {
    flex: 1;
}

.match-title {
    font-weight: 600;
    color: #2d3748;
    margin: 0 0 0.25rem 0;
    font-size: 0.95rem;
}

.match-details {
    color: #718096;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.match-score {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 700;
    min-width: 60px;
    text-align: center;
}

/* Insights Section */
.insights-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 2rem;
}

.insight-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
    overflow: hidden;
}

.insight-header {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
}

.insight-header h3 {
    margin: 0 0 0.25rem 0;
    color: #2d3748;
    font-size: 1.2rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.insight-subtitle {
    color: #718096;
    font-size: 0.9rem;
    margin: 0;
}

.insight-content {
    padding: 1.5rem 2rem;
}

.insight-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.insight-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e2e8f0;
}

.insight-item:last-child {
    border-bottom: none;
}

.insight-name {
    color: #2d3748;
    font-weight: 500;
    font-size: 0.9rem;
}

.insight-count {
    background: #edf2f7;
    color: #4a5568;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
}

/* Loading States */
.loading-state {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.loading-skeleton {
    height: 60px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 8px;
}

.loading-skeleton.small {
    height: 40px;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Responsive Design */
@media (max-width: 1200px) {
    .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .dashboard-actions {
        width: 100%;
        justify-content: flex-start;
    }
}

@media (max-width: 768px) {
    .analytics-container {
        padding: 1rem;
    }
    
    .dashboard-header {
        padding: 1.5rem;
    }
    
    .dashboard-title {
        font-size: 2rem;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .metric-card {
        padding: 1.5rem;
    }
    
    .chart-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .chart-controls {
        order: -1;
        width: 100%;
    }
    
    .btn-filter {
        flex: 1;
        text-align: center;
    }
}

@media (max-width: 480px) {
    .dashboard-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
    
    .detail-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .match-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }
    
    .match-score {
        align-self: flex-end;
    }
}

/* Animation Classes */
.animate-in {
    animation: slideInUp 0.6s ease-out;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.metric-value.counting {
    animation: pulse 0.3s ease-in-out;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
/* ------------- Small helpers ------------- */
const scaleToPercent = (v) => (v == null ? 0 : (v <= 1.000001 ? v * 100 : v));
const withParams = (base, params = {}) => {
  const u = new URL(base, window.location.origin);
  Object.entries(params).forEach(([k, v]) => u.searchParams.set(k, v));
  return u.toString();
};
const parseMaybeItems = (payload) => Array.isArray(payload)
  ? payload
  : (Array.isArray(payload?.items) ? payload.items : (payload?.items || []));

/* ------------- Dashboard ------------- */
class AnalyticsDashboard {
  constructor() {
    this.currentPeriod = 'all';
    this.activityChart = null;
    this.endpoints = {
      main: '/api/analytics/',
      topMatches: '/api/analytics/matches/top/',
      recentActivity: '/api/analytics/activity/recent/',
      companies: '/api/analytics/companies/',
      skills: '/api/analytics/skills/',
      experienceLevels: '/api/analytics/experience-levels/',
    };
    this.data = {};
    this.overlay = document.getElementById('loading-overlay');
    this.errorAlert = document.getElementById('error-alert');
  }

  async init() {
    this.setupEventListeners();
    await this.safeLoadAll();
  }

  /* Loading & error UI */
  showLoading(){ if (this.overlay) this.overlay.classList.remove('hidden'); }
  hideLoading(){ if (this.overlay) this.overlay.classList.add('hidden'); }
  showError(msg){
    if (this.errorAlert){
      const m = document.getElementById('error-message');
      if (m) m.textContent = msg;
      this.errorAlert.style.display = 'flex';
    }
  }
  hideError(){ if (this.errorAlert) this.errorAlert.style.display = 'none'; }

  async safeLoadAll(){
    this.hideError();
    this.showLoading();
    try {
      await this.loadAll();
    } catch (e){
      console.error('Analytics load failed', e);
      this.showError('Failed to load analytics. See console for details.');
    } finally {
      this.hideLoading();
      const el = document.getElementById('last-updated');
      if (el) el.textContent = new Date().toLocaleTimeString();
    }
  }

  setupEventListeners() {
    document.querySelectorAll('.btn-filter').forEach(b => {
      b.addEventListener('click', e => {
        document.querySelectorAll('.btn-filter').forEach(x => x.classList.remove('active'));
        e.currentTarget.classList.add('active');
        this.currentPeriod = e.currentTarget.dataset.period;
        this.safeLoadAll();
      });
    });

    const refreshChartBtn = document.getElementById('refresh-chart-btn');
    if (refreshChartBtn) refreshChartBtn.addEventListener('click', () => this.renderActivityTimeline());

    const refreshAllBtn = document.getElementById('refresh-all-btn');
    if (refreshAllBtn) refreshAllBtn.addEventListener('click', () => this.safeLoadAll());

    const retryBtn = document.getElementById('retry-btn');
    if (retryBtn) retryBtn.addEventListener('click', () => this.safeLoadAll());

    /* === added: export button wiring === */
    const exportBtn = document.getElementById('export-btn');
    if (exportBtn) exportBtn.addEventListener('click', () => this.exportData());
    /* === end added === */
  }

  /* ----------- Load all data & normalize ----------- */
  async loadAll() {
    const params = this.currentPeriod === 'all' ? {} : { period: this.currentPeriod };

    // add the experience levels request
    const [main, topMatches, recentActivity, companies, skills, expLevels] = await Promise.all([
      fetch(withParams(this.endpoints.main, params)).then(r => r.json()),
      fetch(withParams(this.endpoints.topMatches, { limit: 10, ...params })).then(r => r.json()),
      fetch(withParams(this.endpoints.recentActivity, { limit: 10, ...params })).then(r => r.json()),
      fetch(withParams(this.endpoints.companies, { limit: 10 })).then(r => r.json()),
      fetch(withParams(this.endpoints.skills, { limit: 15 })).then(r => r.json()),
      fetch(this.endpoints.experienceLevels).then(r => r.json()).catch(() => ([])), // robust if endpoint fails
    ]);

    const stats = main.statistics || {};
    const scoreDist = main.score_distribution || main.distribution || {}; // might be missing (Option 2)
    const weeklyTrends = Array.isArray(main.weekly_trends)
      ? main.weekly_trends
      : this.normalizeDailyTrends(main.daily_trends);

    const normStats = {
      total_jobs: stats.total_jobs || 0,
      total_resumes: stats.total_resumes || 0,
      total_matches: stats.total_matches || 0,
      avg_score: Number(scaleToPercent(stats.avg_score || 0).toFixed(2)),
      max_score: Number(scaleToPercent(stats.max_score || 0).toFixed(2)),
      min_score: Number(scaleToPercent(stats.min_score || 0).toFixed(2)),
      success_rate: Number((stats.success_rate || 0).toFixed(1)),
    };

    const normTop = (topMatches.items || topMatches || []).map(it => ({
      ...it,
      score: Number(scaleToPercent(it.score).toFixed(1)),
    }));
    const normRecent = (recentActivity.items || recentActivity || []).map(it => ({
      ...it,
      score: Number(scaleToPercent(it.score).toFixed(1)),
    }));
    const normTrends = (weeklyTrends || []).map(t => ({
      ...t,
      avg_score: Number(scaleToPercent(t.avg_score).toFixed(1)),
    }));

    // normalize expLevels from either {items:[...]} or [...]
    const normExperience = parseMaybeItems(expLevels);

    this.data = {
      statistics: normStats,
      score_distribution: scoreDist, // may be empty/summary -> we’ll derive below
      weekly_trends: normTrends,
      top_matches: normTop,
      recent_activity: normRecent,
      top_companies: (companies.items || companies || []),
      top_skills: (skills.items || skills || []),
      experience_levels: normExperience, // <-- now comes from separate endpoint
      period: main.period || this.currentPeriod,
    };

    // Ensure we always have a 5-bucket distribution
    this.ensureDistribution();

    /* Render */
    this.renderMainStats();
    this.renderScoreDistribution();
    this.renderTopMatches();
    this.renderRecentActivity();
    this.renderInsights();
    this.renderActivityTimeline();
  }

  normalizeDailyTrends(daily_trends) {
    if (!daily_trends || typeof daily_trends !== 'object') return [];
    const arr = Object.entries(daily_trends).map(([date, obj]) => ({
      week: date,
      date,
      matches: obj.count || 0,
      avg_score: obj.avg_score ?? 0,
    }));
    return arr.sort((a,b)=> new Date(a.date) - new Date(b.date));
  }

  /* ----------- Rendering ----------- */
  renderMainStats() {
    const s = this.data.statistics;
    this.setCounter('total-jobs', s.total_jobs);
    this.setCounter('total-resumes', s.total_resumes);
    this.setCounter('total-matches', s.total_matches);
    this.setCounter('avg-score', s.avg_score, '%', 1);
    const maxEl = document.getElementById('max-score');
    if (maxEl) maxEl.textContent = s.max_score.toFixed(1);
  }

  setCounter(id, value, suffix = '', decimals = 0) {
    const el = document.getElementById(id);
    if (!el) return;
    const end = Number(value) || 0;
    const start = 0, duration = 600, t0 = performance.now();
    const step = (t) => {
      const p = Math.min((t - t0)/duration, 1), eased = 1 - Math.pow(1-p, 3);
      el.textContent = (start + (end-start)*eased).toFixed(decimals) + suffix;
      if (p < 1) requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
  }

  /* ----------- Client-side distribution (Option 2) ----------- */
  normalizeDistributionObject(raw) {
    if (!raw || typeof raw !== 'object') return null;
    if (Object.keys(raw).length === 0) return null;

    const targets = {
      '90-100': ['90-100','90_100','b90_100'],
      '80-89':  ['80-89','80_89','b80_89'],
      '70-79':  ['70-79','70_79','b70_79'],
      '60-69':  ['60-69','60_69','b60_69'],
      '<60':    ['<60','below_60','blt60'],
    };

    const dist = { '90-100':0,'80-89':0,'70-79':0,'60-69':0,'<60':0 };
    let foundAny = false;

    for (const [target, aliases] of Object.entries(targets)) {
      for (const k of aliases) {
        if (Object.prototype.hasOwnProperty.call(raw, k)) {
          dist[target] = Number(raw[k]) || 0;
          foundAny = true;
          break;
        }
      }
    }
    return foundAny ? dist : null;
  }

  computeDistributionFromLists(lists) {
    const buckets = { '90-100': 0, '80-89': 0, '70-79': 0, '60-69': 0, '<60': 0 };
    const seen = new Set();
    const canon = s => (s == null ? '' : String(s).trim().toLowerCase().replace(/\s+/g, ' '));

    for (const m of (lists || [])) {
      if (!m) continue;

      const idKey   = `${m.cv_id || m.cv_uuid || ''}|${m.job_id || m.job_uuid || ''}`;
      const nameKey = `${canon(m.cv_name)}|${canon(m.job_title)}`;
      if (seen.has(idKey) || seen.has(nameKey)) continue;
      if (idKey)   seen.add(idKey);
      if (nameKey) seen.add(nameKey);

      let s = Number(m.score || 0);
      if (Number.isFinite(s) && s <= 1.000001) s *= 100;

      if (s >= 90) buckets['90-100']++;
      else if (s >= 80) buckets['80-89']++;
      else if (s >= 70) buckets['70-79']++;
      else if (s >= 60) buckets['60-69']++;
      else buckets['<60']++;
    }
    return buckets;
  }

  ensureDistribution() {
    let dist = this.normalizeDistributionObject(this.data.score_distribution);
    if (!dist) {
      const combined = [
        ...(this.data.top_matches || []),
        ...(this.data.recent_activity || []),
      ];
      dist = this.computeDistributionFromLists(combined);
    }
    this.data.score_distribution = dist;
  }

  renderScoreDistribution() {
    const dist = (this.data && this.data.score_distribution) || {};
    const mapping = [
      { key: '90-100', id: '90-100'   },
      { key: '80-89',  id: '80-89'    },
      { key: '70-79',  id: '70-79'    },
      { key: '60-69',  id: '60-69'    },
      { key: '<60',    id: 'below-60' }
    ];
    const total = Math.max(1, mapping.reduce((s,m) => s + (Number(dist[m.key])||0), 0));

    for (const m of mapping) {
      const count = Number(dist[m.key]) || 0;
      const pct = (count / total) * 100;

      const countEl = document.getElementById(`score-${m.id}`);
      const barEl   = document.getElementById(`bar-${m.id}`);

      if (countEl) {
        countEl.textContent = String(count);
        requestAnimationFrame(() => { countEl.textContent = String(count); });
      }
      if (barEl) {
        barEl.style.setProperty('width', `${pct}%`, 'important');
        requestAnimationFrame(() => {
          barEl.style.setProperty('width', `${pct}%`, 'important');
        });
      }
    }
  }

  renderTopMatches() {
    const container = document.getElementById('top-matches-list');
    if (!container) return;
    const items = this.data.top_matches || [];
    if (!items.length) {
      container.innerHTML = this.empty('No matches found', 'trophy');
      return;
    }
    container.innerHTML = items.map((m,i)=>`
      <div class="match-item" style="animation-delay:${i*60}ms">
        <div class="match-info">
          <div class="match-title">${this.escape(m.cv_name)} → ${this.escape(m.job_title)}</div>
          <div class="match-details">
            <i class="fas fa-building"></i> ${this.escape(m.company || 'Unknown')}
            <i class="fas fa-calendar"></i> ${this.formatDate(m.matched_at)}
          </div>
        </div>
        <div class="match-score">${Number(m.score||0).toFixed(1)}%</div>
      </div>
    `).join('');
  }

  renderRecentActivity() {
    const container = document.getElementById('recent-activity-list');
    if (!container) return;
    const items = this.data.recent_activity || [];
    if (!items.length) {
      container.innerHTML = this.empty('No recent activity', 'clock');
      return;
    }
    container.innerHTML = items.map((a,i)=>{
      const when = a.matched_at || a.date || null;
      return `
      <div class="match-item" style="animation-delay:${i*60}ms">
        <div class="match-info">
          <div class="match-title">${this.escape(a.cv_name)} → ${this.escape(a.job_title)}</div>
          <div class="match-details">
            <i class="fas fa-building"></i> ${this.escape(a.company || 'Unknown')}
            <i class="fas fa-clock"></i> ${this.formatRelative(when)}
          </div>
        </div>
        <div class="match-score">${Number(a.score||0).toFixed(1)}%</div>
      </div>`;
    }).join('');
  }

  renderInsights() {
    this.renderInsightList('top-companies', this.data.top_companies);
    this.renderInsightList('top-skills', this.data.top_skills);
    this.renderInsightList('experience-levels', this.data.experience_levels);
  }

  renderInsightList(id, items) {
    const el = document.getElementById(id);
    if (!el) return;
    const list = items || [];
    if (!list.length) {
      el.innerHTML = this.empty('No data available', 'circle-info');
      return;
    }
    el.innerHTML = list.map(i => `
      <div class="insight-item">
        <span class="insight-name">${this.escape(i.name)}</span>
        <span class="insight-count">${this.escape(String(i.count))}</span>
      </div>
    `).join('');
  }

  renderActivityTimeline() {
    const canvas = document.getElementById('activity-chart');
    if (!canvas) return;

    const trends = this.data.weekly_trends || [];
    const labels = trends.map(d => this.prettyDate(d.date));
    const matches = trends.map(d => d.matches || 0);
    const scoresRaw = trends.map(d => d.avg_score || 0);

    const maxScore = Math.max(0, ...scoresRaw);
    const scores = (maxScore > 0 && maxScore <= 1.00001) ? scoresRaw.map(v => v * 100) : scoresRaw;

    if (this.activityChart) this.activityChart.destroy();
    this.activityChart = new Chart(canvas, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label:'Daily Matches', data:matches, yAxisID:'yMatches',
            borderColor:'#4299e1', backgroundColor:'rgba(66,153,225,0.1)', tension:0.4, fill:true, pointRadius:4, pointHoverRadius:7 },
          { label:'Average Score (%)', data:scores, yAxisID:'yScore',
            borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.1)', tension:0.4, fill:true, pointRadius:4, pointHoverRadius:7 }
        ]
      },
      options: {
        responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } },
        scales:{
          x:{ grid:{ display:false } },
          yMatches:{ beginAtZero:true, position:'left', ticks:{ precision:0 } },
          yScore:{ beginAtZero:true, max:100, position:'right', grid:{ drawOnChartArea:false }, ticks:{ callback:v=>`${v}%` } }
        }
      }
    });
  }

  /* === added: export method === */
  exportData() {
    try {
      const payload = {
        statistics: this.data.statistics || {},
        score_distribution: this.data.score_distribution || {},
        weekly_trends: this.data.weekly_trends || [],
        top_matches: this.data.top_matches || [],
        recent_activity: this.data.recent_activity || [],
        top_companies: this.data.top_companies || [],
        top_skills: this.data.top_skills || [],
        experience_levels: this.data.experience_levels || [],
        period: this.data.period || this.currentPeriod
      };

      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `analytics-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (e) {
      console.error('Failed to export data:', e);
      alert('Failed to export data. Please try again.');
    }
  }
  /* === end added === */

  /* ----------- Misc utils ----------- */
  escape(s){ const d=document.createElement('div'); d.textContent = s ?? ''; return d.innerHTML; }
  prettyDate(s){ try{ return new Date(s).toLocaleDateString('en-US',{month:'short', day:'numeric'});}catch{return s||'';} }
  formatDate(s){ try{ return new Date(s).toLocaleDateString('en-US',{month:'short', day:'numeric', year:'numeric'});}catch{return s||'Unknown';} }
  formatRelative(s){
    if (!s) return 'Unknown';
    const dt = new Date(s), diff=(Date.now()-dt.getTime())/1000;
    if (diff < 60) return 'Just now';
    if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff/3600)}h ago`;
    return `${Math.floor(diff/86400)}d ago`;
  }
  empty(message, icon='circle-info'){
    return `
      <div class="loading-state">
        <div style="text-align:center; padding:2rem; color:#718096;">
          <i class="fas fa-${icon}" style="font-size:2rem; margin-bottom:1rem; opacity:.5;"></i>
          <p>${this.escape(message)}</p>
        </div>
      </div>`;
  }
}

document.addEventListener('DOMContentLoaded', ()=> {
  window.dashboard = new AnalyticsDashboard();
  window.dashboard.init();
});
</script>






<!-- FontAwesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

{% endblock %}